alter session set "_oracle_script"=true;

DROP user TRAVELDB CASCADE;

CREATE user TRAVELDB IDENTIFIED BY admin;

alter session set current_schema = TRAVELDB;

GRANT CONNECT TO TRAVELDB;
GRANT CREATE TABLE TO TRAVELDB;
GRANT CREATE SEQUENCE TO TRAVELDB;
GRANT CREATE TRIGGER TO TRAVELDB;

ALTER USER TRAVELDB QUOTA UNLIMITED ON USERS;

CREATE TABLE Utenti (
  id_utente INT generated by default as identity(start with 1) NOT NULL,
  nome VARCHAR2(255) NOT NULL,
  cognome VARCHAR2(255) NOT NULL,
  email VARCHAR2(255) UNIQUE NOT NULL,
  password VARCHAR2(255) NOT NULL,
  PRIMARY KEY (id_utente)
);

CREATE TABLE Posts (
  id_post INT generated by default as identity(start with 1) NOT NULL,
  data DATE,
  titolo VARCHAR2(255) UNIQUE NOT NULL,
  contenuto CLOB NOT NULL,
  utente_id INT,
  PRIMARY KEY (id_post)
);

CREATE TABLE Categorie (
  id_categoria INT generated by default as identity(start with 1) NOT NULL,
  nome_categoria VARCHAR2(255) UNIQUE,
  PRIMARY KEY (id_categoria)
);

CREATE TABLE Favoriti (
  utente_id INT,
  post_id INT,
  PRIMARY KEY(utente_id, post_id)
);

CREATE TABLE Tags (
  post_id INT,
  categoria_id INT,
  PRIMARY KEY(post_id, categoria_id)
);

CREATE TABLE Immagini (
  id_immagine INT generated by default as identity(start with 1) NOT NULL,
  url VARCHAR2(1000) NOT NULL,
  post_id INT,
  PRIMARY KEY(id_immagine)
);

ALTER TABLE Posts ADD CONSTRAINT HAS_WRT FOREIGN KEY (utente_id) REFERENCES Utenti (id_utente) ON DELETE SET NULL;

ALTER TABLE Immagini ADD CONSTRAINT IN_PST FOREIGN KEY (post_id) REFERENCES Posts (id_post) ON DELETE CASCADEL;

ALTER TABLE Favoriti ADD CONSTRAINT HAS_USR FOREIGN KEY (utente_id) REFERENCES Utenti (id_utente) ON DELETE CASCADE;
ALTER TABLE Favoriti ADD CONSTRAINT HAS_PST FOREIGN KEY (post_id) REFERENCES Posts (id_post) ON DELETE CASCADE;

ALTER TABLE Tags ADD CONSTRAINT OF_PST FOREIGN KEY (post_id) REFERENCES Posts (id_post) ON DELETE CASCADE;
ALTER TABLE Tags ADD CONSTRAINT HAS_CTG FOREIGN KEY (categoria_id) REFERENCES Categorie (id_categoria) ON DELETE CASCADE;
